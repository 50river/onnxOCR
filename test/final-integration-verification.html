<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€çµ‚çµ±åˆæ¤œè¨¼ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
        .summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŠ½å‡ºå™¨ - æœ€çµ‚çµ±åˆæ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
        <p>ã“ã®ãƒ†ã‚¹ãƒˆã¯ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŠ½å‡ºå™¨ãŒHTMLã«æ­£ã—ãçµ±åˆã•ã‚Œã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        
        <div class="test-section" id="script-loading">
            <h3>1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ç¢ºèª</h3>
            <p id="script-status">ç¢ºèªä¸­...</p>
        </div>
        
        <div class="test-section" id="class-availability">
            <h3>2. ã‚¯ãƒ©ã‚¹åˆ©ç”¨å¯èƒ½æ€§ç¢ºèª</h3>
            <button onclick="testClassAvailability()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <p id="class-status">æœªå®Ÿè¡Œ</p>
        </div>
        
        <div class="test-section" id="error-handling">
            <h3>3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª</h3>
            <button onclick="testErrorHandling()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <p id="error-status">æœªå®Ÿè¡Œ</p>
        </div>
        
        <div class="test-section" id="real-world-test">
            <h3>4. å®Ÿä¸–ç•Œãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="testRealWorldData()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <p id="real-world-status">æœªå®Ÿè¡Œ</p>
            <pre id="real-world-result"></pre>
        </div>
        
        <div class="test-section" id="app-simulation">
            <h3>5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
            <button onclick="testAppIntegration()">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <p id="app-status">æœªå®Ÿè¡Œ</p>
        </div>
        
        <div class="summary" id="test-summary" style="display: none;">
            <h3>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h3>
            <div id="summary-content"></div>
        </div>
    </div>

    <!-- å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã¨åŒã˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åº -->
    <script src="../js/field-extractor.js"></script>
    
    <script>
        let testResults = {};
        
        // 1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ç¢ºèªï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰
        function checkScriptLoading() {
            const section = document.getElementById('script-loading');
            const status = document.getElementById('script-status');
            
            if (typeof FieldExtractor !== 'undefined' && typeof window.FieldExtractor !== 'undefined') {
                status.textContent = 'âœ… ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŠ½å‡ºå™¨ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ';
                section.className = 'test-section success';
                testResults.scriptLoading = true;
            } else {
                status.textContent = 'âŒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŠ½å‡ºå™¨ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                section.className = 'test-section error';
                testResults.scriptLoading = false;
            }
        }
        
        // 2. ã‚¯ãƒ©ã‚¹åˆ©ç”¨å¯èƒ½æ€§ç¢ºèª
        function testClassAvailability() {
            const section = document.getElementById('class-availability');
            const status = document.getElementById('class-status');
            
            try {
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ãƒ†ã‚¹ãƒˆ
                const extractor = new FieldExtractor();
                
                // å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                const requiredMethods = ['extractFields', 'extractDate', 'extractAmount', 'extractPayee', 'extractPurpose'];
                const missingMethods = requiredMethods.filter(method => typeof extractor[method] !== 'function');
                
                if (missingMethods.length === 0) {
                    status.textContent = 'âœ… ã™ã¹ã¦ã®å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™';
                    section.className = 'test-section success';
                    testResults.classAvailability = true;
                } else {
                    status.textContent = `âš ï¸ ä¸è¶³ã—ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰: ${missingMethods.join(', ')}`;
                    section.className = 'test-section warning';
                    testResults.classAvailability = false;
                }
                
            } catch (error) {
                status.textContent = `âŒ ã‚¯ãƒ©ã‚¹åˆ©ç”¨å¯èƒ½æ€§ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
                section.className = 'test-section error';
                testResults.classAvailability = false;
            }
        }
        
        // 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
        async function testErrorHandling() {
            const section = document.getElementById('error-handling');
            const status = document.getElementById('error-status');
            
            try {
                const extractor = new FieldExtractor();
                
                // å„ç¨®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’ãƒ†ã‚¹ãƒˆ
                const errorCases = [
                    null,
                    undefined,
                    [],
                    [{ invalidData: true }],
                    [{ text: null }],
                    [{ text: "valid", boundingBox: null }]
                ];
                
                let errorHandlingSuccess = 0;
                
                for (const testCase of errorCases) {
                    try {
                        const result = await extractor.extractFields(testCase);
                        
                        // çµæœãŒé©åˆ‡ãªæ§‹é€ ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (result && result.date && result.payee && result.amount && result.purpose) {
                            errorHandlingSuccess++;
                        }
                    } catch (error) {
                        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å¤±æ•—
                        console.warn('Error handling test failed for case:', testCase, error);
                    }
                }
                
                const successRate = (errorHandlingSuccess / errorCases.length * 100).toFixed(1);
                
                if (errorHandlingSuccess === errorCases.length) {
                    status.textContent = `âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸ (${successRate}%)`;
                    section.className = 'test-section success';
                    testResults.errorHandling = true;
                } else {
                    status.textContent = `âš ï¸ éƒ¨åˆ†çš„æˆåŠŸ (${successRate}%)`;
                    section.className = 'test-section warning';
                    testResults.errorHandling = false;
                }
                
            } catch (error) {
                status.textContent = `âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
                section.className = 'test-section error';
                testResults.errorHandling = false;
            }
        }
        
        // 4. å®Ÿä¸–ç•Œãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ
        async function testRealWorldData() {
            const section = document.getElementById('real-world-test');
            const status = document.getElementById('real-world-status');
            const result = document.getElementById('real-world-result');
            
            try {
                const extractor = new FieldExtractor();
                
                // å®Ÿéš›ã®é ˜åæ›¸ã«è¿‘ã„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
                const testData = [
                    {
                        text: "æ ªå¼ä¼šç¤¾ãƒ†ã‚¹ãƒˆãƒãƒ¼ãƒˆ",
                        boundingBox: { x: 0.1, y: 0.1, width: 0.4, height: 0.06 },
                        fontSize: 18
                    },
                    {
                        text: "2024å¹´3æœˆ15æ—¥",
                        boundingBox: { x: 0.1, y: 0.2, width: 0.3, height: 0.04 },
                        fontSize: 12
                    },
                    {
                        text: "å•†å“A",
                        boundingBox: { x: 0.1, y: 0.4, width: 0.15, height: 0.04 },
                        fontSize: 12
                    },
                    {
                        text: "å•†å“B",
                        boundingBox: { x: 0.1, y: 0.45, width: 0.15, height: 0.04 },
                        fontSize: 12
                    },
                    {
                        text: "åˆè¨ˆ Â¥2,500",
                        boundingBox: { x: 0.1, y: 0.7, width: 0.2, height: 0.04 },
                        fontSize: 14
                    }
                ];
                
                const extractionResult = await extractor.extractFields(testData);
                
                // çµæœã®è©•ä¾¡
                const hasValidDate = extractionResult.date.value && extractionResult.date.value.match(/\d{4}\/\d{2}\/\d{2}/);
                const hasValidPayee = extractionResult.payee.value && extractionResult.payee.value.length > 0;
                const hasValidAmount = extractionResult.amount.value > 0;
                const hasValidPurpose = extractionResult.purpose.value && extractionResult.purpose.value.length > 0;
                
                const extractedCount = [hasValidDate, hasValidPayee, hasValidAmount, hasValidPurpose].filter(Boolean).length;
                
                result.textContent = JSON.stringify(extractionResult, null, 2);
                
                if (extractedCount >= 3) {
                    status.textContent = `âœ… å®Ÿä¸–ç•Œãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆæˆåŠŸ (${extractedCount}/4é …ç›®æŠ½å‡º)`;
                    section.className = 'test-section success';
                    testResults.realWorldData = true;
                } else {
                    status.textContent = `âš ï¸ éƒ¨åˆ†çš„æˆåŠŸ (${extractedCount}/4é …ç›®æŠ½å‡º)`;
                    section.className = 'test-section warning';
                    testResults.realWorldData = false;
                }
                
            } catch (error) {
                status.textContent = `âŒ å®Ÿä¸–ç•Œãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
                section.className = 'test-section error';
                result.textContent = error.stack;
                testResults.realWorldData = false;
            }
        }
        
        // 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        function testAppIntegration() {
            const section = document.getElementById('app-simulation');
            const status = document.getElementById('app-status');
            
            try {
                // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                
                // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã®åˆ©ç”¨å¯èƒ½æ€§
                if (typeof window.FieldExtractor === 'undefined') {
                    throw new Error('window.FieldExtractorãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                // 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®åˆæœŸåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³
                const fieldExtractor = new window.FieldExtractor();
                
                // 3. åˆæœŸåŒ–ç¢ºèªï¼ˆapp.jsã®initializeFieldExtractor()ã¨åŒæ§˜ï¼‰
                if (typeof FieldExtractor === 'undefined') {
                    throw new Error('FieldExtractorã‚¯ãƒ©ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const testExtractor = new FieldExtractor();
                
                // 4. åŸºæœ¬ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¢ºèª
                if (!testExtractor.eraConversions || !testExtractor.datePatterns || 
                    !testExtractor.amountPatterns || !testExtractor.companyPatterns) {
                    throw new Error('å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                status.textContent = 'âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ';
                section.className = 'test-section success';
                testResults.appIntegration = true;
                
            } catch (error) {
                status.textContent = `âŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆã‚¨ãƒ©ãƒ¼: ${error.message}`;
                section.className = 'test-section error';
                testResults.appIntegration = false;
            }
            
            // ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ãŸã‚‰ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            showTestSummary();
        }
        
        // ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
        function showTestSummary() {
            const summarySection = document.getElementById('test-summary');
            const summaryContent = document.getElementById('summary-content');
            
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const successRate = (passedTests / totalTests * 100).toFixed(1);
            
            let summaryHTML = `
                <p><strong>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ: ${passedTests}/${totalTests} æˆåŠŸ (${successRate}%)</strong></p>
                <ul>
                    <li>ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿: ${testResults.scriptLoading ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</li>
                    <li>ã‚¯ãƒ©ã‚¹åˆ©ç”¨å¯èƒ½æ€§: ${testResults.classAvailability ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</li>
                    <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ${testResults.errorHandling ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</li>
                    <li>å®Ÿä¸–ç•Œãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ: ${testResults.realWorldData ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</li>
                    <li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ: ${testResults.appIntegration ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</li>
                </ul>
            `;
            
            if (passedTests === totalTests) {
                summaryHTML += '<p style="color: green; font-weight: bold;">ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŠ½å‡ºå™¨ã®HTMLã¸ã®çµ±åˆã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚</p>';
            } else {
                summaryHTML += '<p style="color: orange; font-weight: bold;">âš ï¸ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚çµ±åˆã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>';
            }
            
            summaryContent.innerHTML = summaryHTML;
            summarySection.style.display = 'block';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', function() {
            checkScriptLoading();
        });
    </script>
</body>
</html>