<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCRãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 120px;
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 500;
            color: #374151;
        }
        
        .status-value {
            font-family: monospace;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .log-panel {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #2563eb;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .test-requirements {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-requirements h3 {
            margin: 0 0 10px 0;
            color: #1e40af;
        }
        
        .test-requirements ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .test-requirements li {
            margin-bottom: 5px;
            color: #1e40af;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” OCRãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ</h1>
        <p>æ¤œå‡ºç²¾åº¦ãƒ»èªè­˜ç²¾åº¦ãƒ»å‡¦ç†æ™‚é–“ã®æ¸¬å®šãƒ†ã‚¹ãƒˆ</p>
        <p><strong>è¦ä»¶:</strong> 2.2 (OCRå‡¦ç†), 7.1 (æ€§èƒ½è¦ä»¶)</p>
    </div>

    <div class="test-requirements">
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆè¦ä»¶</h3>
        <ul>
            <li><strong>æ¤œå‡ºç²¾åº¦:</strong> ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸã®æ¤œå‡ºç²¾åº¦70%ä»¥ä¸Š</li>
            <li><strong>èªè­˜ç²¾åº¦:</strong> ãƒ†ã‚­ã‚¹ãƒˆèªè­˜ç²¾åº¦60%ä»¥ä¸Š</li>
            <li><strong>å‡¦ç†æ™‚é–“:</strong> åˆå›OCRå‡¦ç†10ç§’ä»¥å†… (è¦ä»¶7.1)</li>
            <li><strong>ä¿¡é ¼åº¦:</strong> å…¨ä½“ä¿¡é ¼åº¦80%ä»¥ä¸Š (è¦ä»¶2.2)</li>
        </ul>
    </div>

    <div class="test-controls">
        <button id="runAllTests" class="btn btn-primary">ğŸ§ª å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button id="runDetectionTests" class="btn btn-secondary">ğŸ¯ æ¤œå‡ºç²¾åº¦ãƒ†ã‚¹ãƒˆ</button>
        <button id="runRecognitionTests" class="btn btn-secondary">ğŸ“ èªè­˜ç²¾åº¦ãƒ†ã‚¹ãƒˆ</button>
        <button id="runPerformanceTests" class="btn btn-secondary">âš¡ å‡¦ç†æ™‚é–“ãƒ†ã‚¹ãƒˆ</button>
        <button id="clearResults" class="btn btn-secondary">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
    </div>

    <div class="status-panel">
        <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçŠ¶æ…‹</h3>
        <div class="status-item">
            <span class="status-label">OCRã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹</span>
            <span id="engineStatus" class="status-value status-loading">æœªåˆæœŸåŒ–</span>
        </div>
        <div class="status-item">
            <span class="status-label">å®Ÿè¡Œä¸­ã®ãƒ†ã‚¹ãƒˆ</span>
            <span id="currentTest" class="status-value">ãªã—</span>
        </div>
        <div class="status-item">
            <span class="status-label">é€²è¡ŒçŠ¶æ³</span>
            <span id="testProgress" class="status-value">0%</span>
        </div>
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
    </div>

    <div class="performance-metrics" id="performanceMetrics" style="display: none;">
        <div class="metric-card">
            <div id="avgDetectionAccuracy" class="metric-value">-</div>
            <div class="metric-label">å¹³å‡æ¤œå‡ºç²¾åº¦</div>
        </div>
        <div class="metric-card">
            <div id="avgRecognitionAccuracy" class="metric-value">-</div>
            <div class="metric-label">å¹³å‡èªè­˜ç²¾åº¦</div>
        </div>
        <div class="metric-card">
            <div id="avgProcessingTime" class="metric-value">-</div>
            <div class="metric-label">å¹³å‡å‡¦ç†æ™‚é–“</div>
        </div>
        <div class="metric-card">
            <div id="testPassRate" class="metric-value">-</div>
            <div class="metric-label">ãƒ†ã‚¹ãƒˆåˆæ ¼ç‡</div>
        </div>
    </div>

    <div class="status-panel">
        <h3>ğŸ“ ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h3>
        <div id="testLog" class="log-panel">ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„...\n</div>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="../libs/ort.min.js"></script>
    <script src="../libs/tesseract.min.js"></script>
    <script src="../js/exif-reader.js"></script>
    <script src="../js/perspective-correction.js"></script>
    <script src="../js/ocr-engine.js"></script>
    <script src="../js/ocr-worker-manager.js"></script>
    <script src="ocr-pipeline-tests.js"></script>

    <script>
        class OCRPipelineTestRunner {
            constructor() {
                this.testInstance = null;
                this.isRunning = false;
                this.setupEventListeners();
                this.initializeUI();
            }

            setupEventListeners() {
                document.getElementById('runAllTests').addEventListener('click', () => this.runAllTests());
                document.getElementById('runDetectionTests').addEventListener('click', () => this.runDetectionTests());
                document.getElementById('runRecognitionTests').addEventListener('click', () => this.runRecognitionTests());
                document.getElementById('runPerformanceTests').addEventListener('click', () => this.runPerformanceTests());
                document.getElementById('clearResults').addEventListener('click', () => this.clearResults());
            }

            initializeUI() {
                this.updateEngineStatus('æœªåˆæœŸåŒ–', 'loading');
                this.log('OCRãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚');
                this.log('ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ã«ã¯ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
            }

            async runAllTests() {
                if (this.isRunning) return;
                
                try {
                    this.startTest('å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
                    this.testInstance = new OCRPipelineTests();
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ç›£è¦–ã‚’è¨­å®š
                    this.setupProgressMonitoring();
                    
                    await this.testInstance.runAllTests();
                    
                    this.updateMetrics();
                    this.updateEngineStatus('ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    this.log('âœ… å…¨ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    
                } catch (error) {
                    this.updateEngineStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                    this.log(`âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`);
                } finally {
                    this.endTest();
                }
            }

            async runDetectionTests() {
                if (this.isRunning) return;
                
                try {
                    this.startTest('æ¤œå‡ºç²¾åº¦ãƒ†ã‚¹ãƒˆ');
                    this.testInstance = new OCRPipelineTests();
                    
                    await this.testInstance.setupTestEnvironment();
                    await this.testInstance.prepareTestImages();
                    await this.testInstance.testDetectionAccuracy();
                    
                    this.updateMetrics();
                    this.updateEngineStatus('æ¤œå‡ºãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    this.log('âœ… æ¤œå‡ºç²¾åº¦ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    
                } catch (error) {
                    this.updateEngineStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                    this.log(`âŒ æ¤œå‡ºãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                } finally {
                    this.endTest();
                }
            }

            async runRecognitionTests() {
                if (this.isRunning) return;
                
                try {
                    this.startTest('èªè­˜ç²¾åº¦ãƒ†ã‚¹ãƒˆ');
                    this.testInstance = new OCRPipelineTests();
                    
                    await this.testInstance.setupTestEnvironment();
                    await this.testInstance.prepareTestImages();
                    await this.testInstance.testRecognitionAccuracy();
                    
                    this.updateMetrics();
                    this.updateEngineStatus('èªè­˜ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    this.log('âœ… èªè­˜ç²¾åº¦ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    
                } catch (error) {
                    this.updateEngineStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                    this.log(`âŒ èªè­˜ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                } finally {
                    this.endTest();
                }
            }

            async runPerformanceTests() {
                if (this.isRunning) return;
                
                try {
                    this.startTest('å‡¦ç†æ™‚é–“ãƒ†ã‚¹ãƒˆ');
                    this.testInstance = new OCRPipelineTests();
                    
                    await this.testInstance.setupTestEnvironment();
                    await this.testInstance.prepareTestImages();
                    await this.testInstance.testProcessingTime();
                    
                    this.updateMetrics();
                    this.updateEngineStatus('æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                    this.log('âœ… å‡¦ç†æ™‚é–“ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    
                } catch (error) {
                    this.updateEngineStatus('ã‚¨ãƒ©ãƒ¼', 'error');
                    this.log(`âŒ æ€§èƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                } finally {
                    this.endTest();
                }
            }

            startTest(testName) {
                this.isRunning = true;
                this.updateCurrentTest(testName);
                this.updateProgress(0);
                this.updateEngineStatus('å®Ÿè¡Œä¸­', 'loading');
                this.setButtonsEnabled(false);
                this.log(`ğŸš€ ${testName}ã‚’é–‹å§‹ã—ã¾ã™...`);
            }

            endTest() {
                this.isRunning = false;
                this.updateCurrentTest('ãªã—');
                this.updateProgress(100);
                this.setButtonsEnabled(true);
                
                if (this.testInstance) {
                    this.testInstance.cleanupTestEnvironment();
                }
            }

            setupProgressMonitoring() {
                // ãƒ†ã‚¹ãƒˆã®é€²è¡ŒçŠ¶æ³ã‚’ç›£è¦–
                let progress = 0;
                const progressInterval = setInterval(() => {
                    if (!this.isRunning) {
                        clearInterval(progressInterval);
                        return;
                    }
                    
                    progress = Math.min(progress + Math.random() * 10, 95);
                    this.updateProgress(progress);
                }, 500);
            }

            updateMetrics() {
                if (!this.testInstance || !this.testInstance.performanceMetrics) {
                    return;
                }

                const metrics = this.testInstance.performanceMetrics;
                const testResults = this.testInstance.testResults;

                // æ¤œå‡ºç²¾åº¦ã®è¨ˆç®—
                const detectionMetrics = metrics.filter(m => m.test.startsWith('detection_'));
                if (detectionMetrics.length > 0) {
                    const avgDetectionAccuracy = detectionMetrics.reduce((sum, m) => sum + m.accuracy, 0) / detectionMetrics.length;
                    document.getElementById('avgDetectionAccuracy').textContent = `${(avgDetectionAccuracy * 100).toFixed(1)}%`;
                }

                // èªè­˜ç²¾åº¦ã®è¨ˆç®—
                const recognitionMetrics = metrics.filter(m => m.test.startsWith('recognition_'));
                if (recognitionMetrics.length > 0) {
                    const avgRecognitionAccuracy = recognitionMetrics.reduce((sum, m) => sum + m.accuracy, 0) / recognitionMetrics.length;
                    document.getElementById('avgRecognitionAccuracy').textContent = `${(avgRecognitionAccuracy * 100).toFixed(1)}%`;
                }

                // å¹³å‡å‡¦ç†æ™‚é–“ã®è¨ˆç®—
                if (metrics.length > 0) {
                    const avgProcessingTime = metrics.reduce((sum, m) => sum + m.processingTime, 0) / metrics.length;
                    document.getElementById('avgProcessingTime').textContent = `${avgProcessingTime.toFixed(0)}ms`;
                }

                // ãƒ†ã‚¹ãƒˆåˆæ ¼ç‡ã®è¨ˆç®—
                if (testResults.length > 0) {
                    const passedTests = testResults.filter(r => r.passed).length;
                    const passRate = (passedTests / testResults.length) * 100;
                    document.getElementById('testPassRate').textContent = `${passRate.toFixed(1)}%`;
                }

                // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                document.getElementById('performanceMetrics').style.display = 'grid';
            }

            updateEngineStatus(status, type) {
                const statusElement = document.getElementById('engineStatus');
                statusElement.textContent = status;
                statusElement.className = `status-value status-${type}`;
            }

            updateCurrentTest(testName) {
                document.getElementById('currentTest').textContent = testName;
            }

            updateProgress(percentage) {
                document.getElementById('testProgress').textContent = `${Math.round(percentage)}%`;
                document.getElementById('progressFill').style.width = `${percentage}%`;
            }

            setButtonsEnabled(enabled) {
                const buttons = document.querySelectorAll('.btn');
                buttons.forEach(button => {
                    button.disabled = !enabled;
                });
            }

            clearResults() {
                document.getElementById('testLog').textContent = 'ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚\n';
                document.getElementById('performanceMetrics').style.display = 'none';
                this.updateEngineStatus('æœªåˆæœŸåŒ–', 'loading');
                this.updateCurrentTest('ãªã—');
                this.updateProgress(0);
                
                // æ—¢å­˜ã®çµæœè¡¨ç¤ºã‚’å‰Šé™¤
                const existingResults = document.getElementById('ocr-pipeline-test-results');
                if (existingResults) {
                    existingResults.remove();
                }
            }

            log(message) {
                const logElement = document.getElementById('testLog');
                const timestamp = new Date().toLocaleTimeString();
                logElement.textContent += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’UIã«è»¢é€
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        let testRunner;

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            if (testRunner) {
                testRunner.log(args.join(' '));
            }
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            if (testRunner) {
                testRunner.log('âŒ ' + args.join(' '));
            }
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            if (testRunner) {
                testRunner.log('âš ï¸ ' + args.join(' '));
            }
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            testRunner = new OCRPipelineTestRunner();
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            if (testRunner) {
                testRunner.log(`âŒ JavaScript ã‚¨ãƒ©ãƒ¼: ${event.error.message}`);
                testRunner.updateEngineStatus('ã‚¨ãƒ©ãƒ¼', 'error');
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            if (testRunner) {
                testRunner.log(`âŒ Promise æ‹’å¦: ${event.reason}`);
                testRunner.updateEngineStatus('ã‚¨ãƒ©ãƒ¼', 'error');
            }
        });
    </script>
</body>
</html>