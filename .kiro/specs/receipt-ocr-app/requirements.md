# 要件定義書

## 概要

スマートフォンのブラウザ上で完全にオフライン動作する領収書OCRアプリケーション。ユーザーが領収書を撮影し、日付・支払先・金額・適用（利用内容）の4項目を自動抽出してフォームに表示する。抽出精度が低い箇所は、ユーザーが画像上で矩形選択して再OCRできる機能を提供する。

## 要件

### 要件1：画像撮影・取り込み機能

**ユーザーストーリー：** ユーザーとして、スマートフォンで領収書を撮影または既存の画像を選択して、アプリに取り込みたい

#### 受け入れ基準

1. WHEN ユーザーがファイル選択ボタンをタップ THEN システムはカメラまたはギャラリーの選択肢を提示する
2. WHEN ユーザーがカメラを選択 THEN システムは `<input type="file" accept="image/*" capture="environment">` でカメラを起動する
3. WHEN 画像が取り込まれた THEN システムはEXIF情報に基づいて自動的に画像の向きを補正する
4. WHEN 画像が表示された THEN システムは透視補正を自動推定し、四隅のドラッグポイントで手動調整可能にする

### 要件2：自動OCR・構造化機能

**ユーザーストーリー：** ユーザーとして、画像を読み込んだ後に自動的に4項目（日付・支払先・金額・適用）が抽出され、フォームに下書き表示されることを期待する

#### 受け入れ基準

1. WHEN 画像が処理される THEN システムはonnxruntime-webを使用して文字検出と認識の2段階処理を実行する
2. WHEN OCR処理が完了 THEN システムは各フィールドに `{value, confidence, candidates[]}` の形式でデータを保持する
3. WHEN confidence値が0.8未満 THEN システムは該当フィールドに警告表示を行う
4. WHEN 処理中 THEN システムは進行状況インジケータを表示する

### 要件3：手動範囲選択・再OCR機能

**ユーザーストーリー：** ユーザーとして、自動抽出が不正確な箇所について、画像上で範囲を選択して再OCRし、結果をフィールドに反映したい

#### 受け入れ基準

1. WHEN ユーザーが画像上でドラッグ操作を行う THEN システムは半透明の矩形選択オーバーレイを表示する
2. WHEN 矩形選択が完了 THEN システムは選択領域を高解像度で再OCRする
3. WHEN 再OCR結果が得られる THEN システムは候補リストに追加し、ユーザーがフィールドに採用できるようにする
4. WHEN 画像表示中 THEN システムはズーム・パン操作をサポートする

### 要件4：データ正規化機能

**ユーザーストーリー：** ユーザーとして、抽出されたデータが標準的な形式に正規化されることを期待する

#### 受け入れ基準

1. WHEN 日付が抽出される THEN システムはYYYY/MM/DD、YYYY-MM-DD、YYYY年M月D日、和暦（令/平/昭/大）を西暦YYYY/MM/DD形式に正規化する
2. WHEN 金額が抽出される THEN システムは¥?\d{1,3}(,\d{3})*または\d+円のパターンを認識し、合計/税込/お会計近傍の値を優先して整数で保持する
3. WHEN 支払先が抽出される THEN システムは上部または大フォント行、「株式会社/有限会社/店/商店/堂/薬局」語尾を優先して選択する
4. WHEN 適用項目が抽出される THEN システムは明細行から名詞句を抽出し、1-2文で要約する（例：「会議費」「打合せ飲食代」）

### 要件5：ローカル保存・エクスポート機能

**ユーザーストーリー：** ユーザーとして、抽出結果をローカルに保存し、様々な形式でエクスポートしたい

#### 受け入れ基準

1. WHEN ユーザーがエクスポートを選択 THEN システムはJSON・CSV形式での出力を提供する
2. WHEN ユーザーが完全保存を選択 THEN システムは画像と抽出結果をZIP形式で保存する
3. WHEN データが保存される THEN システムはIndexedDBに履歴を保存し、上限50件でLRU方式で管理する
4. WHEN 保存操作が実行される THEN システムはユーザーの明示的な操作時のみ実行し、既定ではメモリ上に保持する

### 要件6：PWA・オフライン機能

**ユーザーストーリー：** ユーザーとして、インターネット接続がない環境でもアプリを使用したい

#### 受け入れ基準

1. WHEN アプリが初回ロードされる THEN システムはmanifest.jsonとservice workerでPWAとして動作する
2. WHEN 2回目以降のアクセス THEN システムは機内モードでも完全に動作する
3. WHEN service workerが動作 THEN システムはlibs/、models/、assets/をプリキャッシュする
4. WHEN アップデートが利用可能 THEN システムはskipWaiting/clientsClaimで即座に更新を適用する

### 要件7：性能・ユーザビリティ

**ユーザーストーリー：** ユーザーとして、現行のスマートフォンで快適に動作するアプリを期待する

#### 受け入れ基準

1. WHEN 初回OCR処理が実行される THEN システムはiOS Safari/Android Chromeで10秒以内に完了する
2. WHEN ランタイムが初期化される THEN システムはWebGPU>WebGL>WASMの順で最適なバックエンドを自動選択する
3. WHEN 処理が実行中 THEN システムは明確な進行状況インジケータを表示する
4. WHEN アプリがロードされる THEN システムは軽量モデルと遅延ロードで初回ダウンロードを30-50MB以内に抑制する

### 要件8：セキュリティ・プライバシー

**ユーザーストーリー：** ユーザーとして、個人情報が外部に送信されることなく、安全にアプリを使用したい

#### 受け入れ基準

1. WHEN アプリが動作する THEN システムは一切の外部通信を行わない
2. WHEN セキュリティポリシーが適用される THEN システムはCSP（Content Security Policy）とPermissions-Policyを設定する
3. WHEN データが保存される THEN システムはユーザーの明示的な操作時のみ実行する
4. WHEN エラーが発生 THEN システムは適切なフォールバック機能（tesseract.js）を提供し、UIで明示する