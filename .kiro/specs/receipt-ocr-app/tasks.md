# 実装計画

- [x] 1. PWA基盤とプロジェクト構造の構築
  - プロジェクトディレクトリ構造の作成
  - PWA manifest.jsonとservice workerの実装
  - 基本的なHTML/CSS/JSファイルの作成
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [x] 1.1 基本的なHTMLとCSSの実装
  - レスポンシブなレイアウトの作成
  - 画像表示エリアとフォームエリアの配置
  - アクセシビリティ対応（スクリーンリーダー、48px以上のタップ領域）
  - _要件: 8.2, 7.3_

- [x] 1.2 Service Workerとキャッシュ戦略の実装
  - libs/、models/、assets/のプリキャッシュ機能
  - skipWaiting/clientsClaimによる即座更新
  - オフライン時のフォールバック処理
  - _要件: 6.2, 6.3, 6.4_

- [x] 1.3 PWA機能のテスト
  - オフライン動作の確認
  - インストール可能性の検証
  - キャッシュ更新の動作確認
  - _要件: 6.1, 6.2_

- [x] 2. 画像取り込みと前処理機能の実装
  - カメラ・ファイル選択UIの実装
  - EXIF情報による自動回転補正
  - 透視補正の自動推定と手動調整UI
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [x] 2.1 ファイル入力とカメラアクセスの実装
  - `<input type="file" accept="image/*" capture="environment">`の実装
  - ファイル選択時の画像読み込み処理
  - エラーハンドリング（権限拒否、ファイル形式エラー）
  - _要件: 1.1, 1.2, 8.3_

- [x] 2.2 EXIF回転補正機能の実装
  - EXIF情報の読み取り処理
  - 画像の自動回転補正
  - 補正後の画像表示
  - _要件: 1.3_

- [x] 2.3 透視補正UIと処理の実装
  - 四隅ドラッグポイントによる手動調整UI
  - OpenCV.jsを使用した透視補正処理
  - 自動推定アルゴリズムの実装
  - _要件: 1.4_

- [x] 2.4 画像前処理のユニットテスト
  - EXIF補正の各回転角度テスト
  - 透視補正の精度テスト
  - エラーケースの処理確認
  - _要件: 1.3, 1.4_

- [x] 3. ONNX Runtime Webの初期化とモデル管理
  - バックエンド自動選択機能（WebGPU>WebGL>WASM）
  - モデルファイルの遅延ロード機能
  - エラーハンドリングとフォールバック機能
  - _要件: 7.1, 7.2, 8.4_

- [x] 3.1 ONNX Runtime Webの初期化処理
  - バックエンド検出と優先順位による選択
  - 初期化エラー時のフォールバック処理
  - 初期化状態の管理
  - _要件: 7.2, 8.4_

- [x] 3.2 モデルファイルの動的ロード機能
  - 検出モデル（text_det.onnx）のロード
  - 認識モデル（text_rec_jp.onnx）のロード
  - 角度分類モデル（text_angle.onnx）のロード
  - 文字セット（charset_jp.txt）の読み込み
  - _要件: 2.2, 7.4_

- [x] 3.3 Tesseract.jsフォールバック機能
  - ONNX失敗時の自動切り替え
  - フォールバック状態のUI表示
  - 性能差の明示
  - _要件: 8.4_

- [x] 3.4 OCRエンジンの初期化テスト
  - 各バックエンドの動作確認
  - モデルロードの成功/失敗テスト
  - フォールバック機能のテスト
  - _要件: 7.2, 8.4_

- [x] 4. OCRパイプライン（検出→認識）の実装
  - テキスト検出処理の実装
  - 検出領域の切り出し処理
  - テキスト認識処理の実装
  - Web Workerによる非同期処理
  - _要件: 2.1, 2.2, 7.3_

- [x] 4.1 テキスト検出機能の実装
  - DBNet系モデルによる文字領域検出
  - バウンディングボックスの生成
  - 検出結果の後処理（NMS等）
  - _要件: 2.2_

- [x] 4.2 テキスト認識機能の実装
  - 切り出し領域の前処理
  - CRNN/Transformer系モデルによる文字認識
  - 日本語文字セットによるデコード処理
  - _要件: 2.2_

- [x] 4.3 Web Workerによる非同期処理
  - OCR処理のワーカー化
  - 進行状況の通知機能
  - メインスレッドとの通信処理
  - _要件: 7.3_

- [x] 4.4 OCRパイプラインのテスト
  - 検出精度のテスト
  - 認識精度のテスト
  - 処理時間の測定
  - _要件: 2.2, 7.1_

- [x] 5. フィールド抽出と正規化ロジックの実装
  - 日付・支払先・金額・適用の抽出アルゴリズム
  - 和暦から西暦への変換機能
  - 金額近傍キーワードによるスコアリング
  - 候補生成と信頼度計算
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 5.1 日付抽出と正規化機能
  - 日付パターンの正規表現マッチング
  - 和暦（令/平/昭/大）から西暦への変換
  - YYYY/MM/DD形式への正規化
  - _要件: 4.1_

- [x] 5.2 金額抽出とスコアリング機能
  - 金額パターンの認識（¥?\d{1,3}(,\d{3})*, \d+円）
  - 近傍キーワード（合計/税込/お会計）による重み付け
  - 複数候補からの最適値選択
  - _要件: 4.2_

- [x] 5.3 支払先推定機能
  - 上部・大フォント行の優先処理
  - 企業語尾（株式会社/有限会社/店/商店/堂/薬局）の検出
  - 位置とフォントサイズによるスコアリング
  - _要件: 4.3_

- [x] 5.4 適用項目の要約機能
  - 明細行からの名詞句抽出
  - TF-IDFスコアによる重要語句選択
  - 1-2文での要約生成
  - _要件: 4.4_

- [x] 5.5 フィールド抽出のユニットテスト
  - 日付変換の境界値テスト（元号境界年含む）
  - 金額抽出の精度テスト
  - 支払先推定の精度テスト
  - 適用要約の品質テスト
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 6. 矩形選択と再OCR機能の実装
  - 画像上での矩形選択UI
  - ズーム・パン機能
  - 選択領域の高解像度再OCR
  - 候補追加と採用機能
  - _要件: 3.1, 3.2, 3.3_

- [x] 6.1 矩形選択オーバーレイの実装
  - ドラッグによる矩形選択UI
  - 半透明オーバーレイの表示
  - 選択範囲の調整機能
  - _要件: 3.1, 3.2_

- [x] 6.2 ズーム・パン機能の実装
  - タッチジェスチャーによるズーム操作
  - パン（移動）操作の実装
  - 座標変換の処理
  - _要件: 3.2_

- [x] 6.3 選択領域の再OCR処理
  - 元画像からの高解像度リサンプリング
  - 選択領域のみのOCR実行
  - 結果の候補リストへの追加
  - _要件: 3.2, 3.3_

- [x] 6.4 矩形選択機能のテスト
  - 選択精度のテスト
  - ズーム・パン操作のテスト
  - 再OCR精度の確認
  - _要件: 3.1, 3.2, 3.3_

- [x] 7. UIフォームと候補表示機能の実装
  - 4項目入力フォームの実装
  - 信頼度表示とアラート機能
  - 候補履歴の表示と選択機能
  - 進行状況インジケータ
  - _要件: 2.3, 7.3_

- [x] 7.1 領収書データ入力フォームの実装
  - 日付・支払先・金額・適用の入力フィールド
  - バリデーション機能
  - アクセシビリティ対応（ラベル、フォーカス管理）
  - _要件: 2.3_

- [x] 7.2 信頼度表示とアラート機能
  - confidence < 0.8 の警告表示
  - 視覚的なインジケータ（色、アイコン）
  - ユーザーへの改善提案
  - _要件: 2.3_

- [x] 7.3 候補履歴と選択機能
  - 候補リストの表示UI
  - 候補の採用・却下機能
  - 履歴の管理と表示
  - _要件: 3.3_

- [x] 7.4 進行状況インジケータの実装
  - OCR処理の進行状況表示
  - エラー状態の表示
  - 処理完了の通知
  - _要件: 7.3_

- [x] 7.5 UIコンポーネントのテスト
  - フォーム操作のテスト
  - 候補選択機能のテスト
  - アクセシビリティのテスト
  - _要件: 2.3, 7.3_

- [x] 8. データ保存とエクスポート機能の実装
  - IndexedDBによる履歴管理
  - JSON・CSVエクスポート機能
  - ZIP形式での画像付き保存
  - LRU方式による上限管理
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 8.1 IndexedDBストレージの実装
  - データベーススキーマの定義
  - CRUD操作の実装
  - LRU方式による50件上限管理
  - _要件: 5.3, 5.4_

- [x] 8.2 エクスポート機能の実装
  - JSON形式でのデータ出力
  - CSV形式でのデータ出力
  - ファイルダウンロード機能
  - _要件: 5.1_

- [x] 8.3 ZIP保存機能の実装
  - 画像と抽出結果の組み合わせ
  - JSZipライブラリの統合
  - 圧縮ファイルの生成とダウンロード
  - _要件: 5.2_

- [x] 8.4 ストレージ機能のテスト
  - データ保存・読み込みのテスト
  - エクスポート機能のテスト
  - 上限管理のテスト
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 9. エラーハンドリングと例外処理の実装
  - 権限エラーの処理
  - メモリ不足エラーの処理
  - ネットワークエラーの処理
  - ユーザーフレンドリーなエラーメッセージ
  - _要件: 8.1, 8.3, 8.4_

- [x] 9.1 権限関連エラーの処理
  - カメラアクセス拒否時の処理
  - ストレージ制限時の処理
  - 代替手段の提供
  - _要件: 8.3_

- [x] 9.2 リソース不足エラーの処理
  - メモリ不足時の画像サイズ縮小
  - 処理タイムアウトの処理
  - 段階的な品質低下
  - _要件: 7.1, 7.4_

- [x] 9.3 ユーザーフレンドリーなエラー表示
  - 分かりやすいエラーメッセージ
  - 解決方法の提案
  - エラー状態からの復旧機能
  - _要件: 8.4_

- [x] 9.4 エラーハンドリングのテスト
  - 各種エラーケースの確認
  - フォールバック機能のテスト
  - ユーザビリティのテスト
  - _要件: 8.1, 8.3, 8.4_

- [x] 10. ブラウザテストと最適化
  - iOS Safari / Android Chromeでの動作確認
  - パフォーマンス測定と最適化
  - メモリ使用量の最適化
  - E2Eテストの実装
  - _要件: 7.1, 7.4_

- [x] 10.1 クロスブラウザ互換性テスト
  - iOS 16+ Safariでの動作確認
  - Android 10+ Chromeでの動作確認
  - 機能差異の確認と対応
  - _要件: 7.1_

- [x] 10.2 パフォーマンス測定と最適化
  - 初回OCR処理時間の測定（≤10秒目標）
  - メモリ使用量の監視
  - バンドルサイズの最適化（≤30-50MB）
  - _要件: 7.1, 7.4_

- [x] 10.3 E2Eテストの実装
  - 実際の領収書画像を使用したテスト
  - 4項目抽出の精度確認（2項目以上でconfidence≥0.8）
  - 矩形選択による再OCRのテスト
  - オフライン動作の確認
  - _要件: 2.2, 3.2, 6.2_